# API 数据深度分析报告

## 📊 测试结果汇总

**测试时间**: 2026-02-05 11:54:23
**测试基金**: 华夏成长混合 (000001)
**测试股票**: 000001 (平安银行), 000002 (万科A)

### 整体表现

| 指标 | 数值 | 评价 |
|------|------|------|
| 总 API 数 | 3 | ✅ |
| 成功数 | 3 | ✅ 100% |
| 失败数 | 0 | ✅ |
| 平均响应时间 | 299ms | ✅ 优秀 |

---

## 🔍 API 逐一分析

### 1. 基金持仓数据 API

**URL**: `https://fundf10.eastmoney.com/ccmx_000001.html`

#### 基础指标
- ✅ **状态**: 成功
- ⏱️ **响应时间**: 294ms
- 📄 **内容类型**: `text/html; charset=utf-8`
- 📏 **内容长度**: 37,230 字节
- 🔍 **持仓数据**: 存在

#### 数据质量分析

**优点**:
1. 响应速度快 (<300ms)
2. 页面完整，包含持仓信息
3. 编码正确 (UTF-8)

**问题**:
1. ⚠️ **HTML 格式复杂**: 需要解析 HTML 才能提取结构化数据
2. ⚠️ **样本数据模糊**: 正则匹配到的不是真正的持仓数据，而是 HTML 标签和 meta 信息

#### 样本数据分析

当前正则 `(\d{6})[^\d]*?([^<]+)` 匹配到的内容：
```
000001)基金持仓 _ 基金档案 _ 天天基金网<
000001,基金,基金档案,F10,基金持仓,天天基金网,fund,1234567" />
```

**问题**: 这些都是 HTML 元素，不是真正的持仓数据。

#### 真实持仓数据位置

需要进一步分析 HTML 结构，找到真正的持仓表格。根据经验，东方财富的持仓数据通常在：
- `<table class="stockholdings">` 或类似表格
- JSON 数据嵌入在 `<script>` 标签中

#### 建议改进

```typescript
// 需要更精确的解析逻辑
const stockTableMatch = html.match(/<table[^>]*stockholdings[\s\S]*?<\/table>/i);
// 或者查找 JSON 数据
const jsonMatch = html.match(/var stockholdings = ({[\s\S]*?});/);
```

---

### 2. 实时股票行情 API (push2)

**URL**: `https://push2.eastmoney.com/api/qt/stock/get?secid=0.000001,0.000002&fields=...`

#### 基础指标
- ✅ **状态**: 成功
- ⏱️ **响应时间**: 318ms
- 📦 **返回码**: `rc=100` (成功)
- ⚡ **响应类型**: `rt=1` (实时数据)
- 🖥️ **服务器**: `svr=180606400`
- 📊 **数据条数**: **0** ⚠️

#### 关键问题：dataCount = 0

**原因分析**:
1. **非交易时间**: 测试时可能是非交易时段（周末或收盘后）
2. **字段配置问题**: 请求的字段可能不完整
3. **股票代码格式**: 可能需要调整格式

#### 字段说明

当前请求的字段：
```
f43,f44,f45,f46,f47,f48,f49,f50,f51,f52,f57,f58,f60,f107,f116,f117,f127,f152,f161,f162,f167,f168,f169,f170,f171,f84,f85,f115
```

**核心字段映射**:
- `f43` - 最新价
- `f44` - 最高价
- `f45` - 最低价
- `f46` - 开盘价
- `f47` - 昨收价
- `f60` - 昨收价（备用）
- `f116` - 涨跌幅
- `f107` - 涨跌额
- `f170` - 涨速

#### 建议改进

1. **交易时间测试**: 在交易时间（9:30-15:00）重试
2. **简化字段**: 先测试核心字段
3. **添加备用字段**: 增加 `f58` (成交量), `f84` (市盈率)

---

### 3. 腾讯行情 API (qt.gtimg)

**URL**: `https://qt.gtimg.cn/q=sz000001,sz000002`

#### 基础指标
- ✅ **状态**: 成功
- ⏱️ **响应时间**: 284ms ⚡ (最快)
- 📝 **响应长度**: 1,038 字节
- ✅ **数据存在**: 是
- 📊 **数据条数**: 2

#### 数据格式分析

返回格式：
```
v_sz000001="平安银行~GP-A~..."
v_sz000002="万科A~GP-A~..."
```

#### 字段解析问题

**当前问题**: 价格显示为 `undefined`

**原因**:
1. 字段位置索引可能不正确
2. 字段分隔符不是简单的空格
3. 数据格式使用了 `~` 分隔

#### 实际数据格式分析

样本数据：
```
sz000002: 价格=~GP-A~4.95~-4.87~0.00~-33.88~-5.33~8.22~4.62~-1.41~-0.41...
```

**格式**: `字段1~字段2~字段3~...`

**标准字段位置** (需要验证):
- 位置 0: 名称
- 位置 1: 类型 (GP-A=A股)
- 位置 2: 当前价
- 位置 3: 昨收价
- 位置 4: 涨跌额
- 位置 5: 涨跌幅(%)
- 位置 6: 开盘价
- 位置 7: 最高价
- 位置 8: 最低价
- ...

#### 修正建议

```typescript
// 当前错误的解析方式
const values = parts[1].replace(/"/g, '').split(' ');

// 应该使用 ~ 作为分隔符
const values = parts[1].replace(/"/g, '').split('~');

const price = values[2];      // 当前价
const changePct = values[5];  // 涨跌幅
```

#### 优势

1. ✅ 响应速度最快 (284ms)
2. ✅ 数据格式简单
3. ✅ 无需 JSON 解析
4. ✅ 支持批量查询

#### 劣势

1. ⚠️ 字段位置不直观
2. ⚠️ 缺少官方文档
3. ⚠️ 格式可能变化

---

## 🎯 关键发现

### 1. 持仓数据解析问题 ⚠️⚠️⚠️

**严重性**: 高
**影响**: 无法获取基金持仓信息

**问题**: 当前正则表达式匹配到的是 HTML 标签，而不是真实的持仓数据

**解决方案**:
1. 使用 Cheerio 库解析 HTML
2. 找到正确的表格或 JSON 数据源
3. 重新设计数据提取逻辑

### 2. push2 API 空数据 ⚠️

**严重性**: 中
**影响**: 无法获取实时行情（push2 源）

**可能原因**:
1. 非交易时间
2. 字段配置问题
3. 代码格式问题

**解决方案**:
1. 交易时间重测
2. 对比官方文档调整字段
3. 验证股票代码格式

### 3. 腾讯 API 解析错误 ⚠️

**严重性**: 中
**影响**: 价格显示为 undefined

**问题**: 使用空格分隔符，实际使用 `~` 分隔

**解决方案**:
- 修改分隔符为 `~`
- 更新字段位置索引

---

## 📋 下一步行动计划

### Priority 1: 修复持仓数据解析

```typescript
// 安装依赖
pnpm add cheerio

// 创建新的解析器
// lib/valuation/holdings-parser.ts
import * as cheerio from 'cheerio';

export function parseHoldingsFromHtml(html: string) {
  const $ = cheerio.load(html);
  const holdings = [];

  // 方法1: 解析表格
  $('table.stockholdings tr').each((i, row) => {
    const cells = $(row).find('td');
    // 提取数据...
  });

  // 方法2: 查找 JSON
  const scriptData = $('script').html();
  const jsonMatch = scriptData.match(/var stockholdings = ({[\s\S]*?});/);

  return holdings;
}
```

### Priority 2: 修复腾讯 API 解析

```typescript
// 修改分隔符
const values = parts[1].replace(/"/g, '').split('~');

// 更新字段位置
const currentPrice = values[2];
const changePercent = values[5];
```

### Priority 3: 交易时间测试 push2 API

等待交易日 9:30-15:00 重新测试

---

## 📊 性能基准

| API | 平均响应时间 | 性能等级 |
|-----|-------------|---------|
| 腾讯行情 API | 284ms | ⚡ 优秀 |
| 基金持仓 API | 294ms | ✅ 良好 |
| push2 API | 318ms | ✅ 良好 |

**推荐策略**: 使用腾讯 API 作为主要行情源，push2 作为备用

---

## 🔗 相关文档

- [Phase 1 验证报告](/docs/phase1-api-verification-report.md)
- [超时修复报告](/docs/timeout-fix-report.md)
- [完整开发计划](/plan2.1.md)

---

**报告生成时间**: 2026-02-05 19:54:23
**下次更新**: 修复持仓解析后
